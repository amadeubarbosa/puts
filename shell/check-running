#!/bin/ksh

TECTOOLS_HOME=/home/t/tecgraf/lib
TECMAKE_HOME=$TECTOOLS_HOME/tecmake
export TECMAKE_HOME

OPENBUS_HOME=/local/openbus/openbus-testes
ACS_PID=$OPENBUS_HOME/data/acs.pid
RGS_PID=$OPENBUS_HOME/data/rgs.pid
SS_PID=$OPENBUS_HOME/data/ss.pid

# loading the tecmake variables
if [ -f $TECMAKE_HOME/tec_uname.bsh ]; then
	# workaround to bad assigns in that tec_uname file
	ORIG_TECMAKEHOME=$TECMAKE_HOME
	ORIG_TECTOOLSHOME=$TECTOOLS_HOME
	. $TECMAKE_HOME/tec_uname.bsh
	# restoring the variables to the correct values
	TECMAKE_HOME=$ORIG_TECMAKEHOME
	TECTOOLS_HOME=$ORIG_TECTOOLSHOME
fi

# function to check if is running actually
is_running() {
	# if not exist the PID files
	if [ ! -f $ACS_PID ] || [ ! -f $RGS_PID ] || [ ! -f $SS_PID ]; then
		return 1
	else
		# the PID file can be outdated, asking for them
		ps -e |grep $(cat $ACS_PID 2>/dev/null) 1>/dev/null 2>/dev/null
		acs_ret=$?
		ps -e |grep $(cat $RGS_PID 2>/dev/null) 1>/dev/null 2>/dev/null
		rgs_ret=$?
		ps -e |grep $(cat $SS_PID 2>/dev/null) 1>/dev/null 2>/dev/null
		ss_ret=$?
		# if some PID is outdated then remove that file and return false
		running=0
		if [ $acs_ret -gt 0 ]; then
			echo "apaguei"
			rm -f $ACS_PID
			running=1
		fi
		if [ $rgs_ret -gt 0 ]; then
			echo "apaguei"
			rm -f $RGS_PID
			running=1
		fi
		if [ $ss_ret -gt 0 ]; then
			echo "apaguei"
			rm -f $SS_PID
			running=1
		fi
		return $running
	fi
	# no problem, all is running
	return 0
}

# check if is running
is_running
ret=$?
# when some error try restart
if [ $ret -gt 0 ] ; then
	# probably the services has crashed!
	# it will try stop any other openbus services
	/etc/init.d/openbus stop

	CRASH_DIR=$OPENBUS_HOME/data/crashes
	TAG=`date +%Y%m%d-%H:%M:%S`
	mkdir -p $CRASH_DIR

	cp $OPENBUS_HOME/data/acs.log $CRASH_DIR/acs-$TAG.log
	gzip $CRASH_DIR/acs-$TAG.log
	cp $OPENBUS_HOME/data/rgs.log $CRASH_DIR/rgs-$TAG.log
	gzip $CRASH_DIR/rgs-$TAG.log
	cp $OPENBUS_HOME/data/ss.log $CRASH_DIR/ss-$TAG.log
	gzip $CRASH_DIR/ss-$TAG.log
	
	/etc/init.d/openbus start
	echo "Ol√°,
Sou um notificador autom√tico, que acabou de ver que os servicos do OpenBus na
m√°quina Ubu/TecGraf falharam!
Acabo de reiniciar os servicos, talvez seja importante voc√™ olhar os logs que
foram salvos em:
  $CRASH_DIR/acs-$TAG.log
  $CRASH_DIR/rgs-$TAG.log
  $CRASH_DIR/ss-$TAG.log

Atenciosamente,
Crontab da M√°quina Ubu/TecGraf
Autor: Amadeu Barbosa (amadeu@tecgraf.puc-rio.br)" |\
	 mail -s "Falha e rein√≠cio do barramento na Ubu/TecGraf" amadeu@tecgraf.puc-rio.br
fi
